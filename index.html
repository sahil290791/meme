<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ED8335">
	<title>Meme Generator</title>
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="css/reset.min.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
</head>
<body>
	<div class="header">
		<h3>MEME Generator</h3>
	</div>
	<div class="container">
		<div class="fields-container">
			<div class="form-field">
				<label for="upload">Choose an Image: </label>
				<input type="file" id="upload" class="uploadFile" />
			</div>	
			<div class="textSetup">
				<h4>Text Settings:</h4>
				<div class="form-field block" >
					<label for="topText">Enter Top Line:</label>
					<input type="text" id="topText" placeholder="Text to be placed at the top" />
				</div>
				<div class="form-field block">	
					<label for="bottomTxt">Enter Bottom Line:</label>
					<input type="text" id="bottomTxt" value="" placeholder="Text to be placed at the bottom"/>
				</div>	
				<div class="form-field">	
					<label for="textHeight">Adjust Font Size:</label>
					<input type="range" id="textHeight" value="30" max="60" min="5" step="5" />
				</div>	
			</div>
			
			<div class="imageSetup">
				<h4>Picture Settings:</h4>
				<div class="form-field filterType">
					<label>Choose Filter Type:</label>
					<label for="presets"><input type="radio" id="presets" name="filterType" value="presets"> Presets</label>
					<label for="diy"><input type="radio" id="diy" name="filterType" value="diy"> DIY</label>
				</div>
				<div class="form-field presets">	
					<label>Apply image filter:</label><br/>
						<label for="greyscale"><input type="radio" name="filter" id="greyscale" class="radio" value="greyscale" />GreyScale</label>
						<label for="red"><input type="radio" name="filter" id="red" class="radio" value="red" />Red</label>
						<label for="green"><input type="radio" name="filter" id="green" class="radio" value="green" />Green</label>
						<label for="blue"><input type="radio" name="filter" id="blue" class="radio" value="blue" />Blue</label>
						<label for="reset"><input type="radio" name="filter" id="reset" class="radio" value="reset" />Reset Filter</label>
				</div>	
				<div class="form-field diy">	
					<label>Change RGBA values:</label>
					<div>
						R: <input type="range" name="filter" id="r" class="rgba" min="0" max="1" step="0.1" value="1"/>
					</div>	
					<div>
						G: <input type="range" name="filter" id="g" class="rgba" min="0" max="1" step="0.1" value="1"/>
					</div>
					<div>
						B: <input type="range" name="filter" id="b" class="rgba" min="0" max="1" step="0.1" value="1"/>
					</div>
					<div>
						A: <input type="range" name="filter" id="a" class="rgba" min="0" max="1" step="0.1" value="1"/>
					</div>
				</div>	
			</div>
			<div class="form-field saveImg">
				<button class="save">Save Image</button>
			</div>
			<canvas id="sheet" width="500" height="500"></canvas>
		</div>
	</div>
	<script type="text/javascript">
		var c = document.querySelector('#sheet');
		var ctx = c.getContext('2d');
		var imgData, imgdata;
		var windWidth = document.querySelector('.fields-container').offsetWidth;
		
		var meme = {
			init: function() {
				this.setFieldValues();
				this.activateListners();
				this.adjustCanvasDimension(300, windWidth);
				meme.r = meme.g = meme.b = meme.a = 1;
			},
			setFieldValues: function() {
				this.topTxt = document.getElementById('topText');
				this.topTxt.value = "";
				this.bottomTxt = document.getElementById('bottomTxt');
				this.bottomTxt.value = "";
				this.topTxt.addEventListener('input',this.textListner, false);
				this.bottomTxt.addEventListener('input',this.textListner, false);
				this.fontHeight = document.getElementById('textHeight');
				this.fontHeight.value = 20;
				this.fontHeight.addEventListener('input',this.adjustFontHeight, false);
				this.radioBtns = document.getElementsByClassName('radio');
				for (radioBtn in this.radioBtns){
					this.radioBtns[radioBtn].onclick = function() {
						var filter = this.value;
						meme.updateCanvas(filter);
					}
				}
				this.rgbaValues = document.getElementsByClassName('rgba');
				for( i in this.rgbaValues){
					this.rgbaValues[i].onchange = function() {
						switch(this.id){
							case 'r':
								meme.r = this.value;
								break;
							case 'g':
								meme.g = this.value;
								break;
							case 'b':
								meme.b= this.value;
								break;
							case 'a':	
								meme.a = this.value;
								break;
							default:
								break;
						}
						meme.updateCanvas(this.value);
					}
				}
			},
			updateCanvas: function(filter) {
				meme.redraw();
				imgdata = meme.imgData();
				var data = imgdata.data;
				if (filter !== "reset") {
					for(i=0;i < (data.length); i+=4){
						r=data[i];
						g=data[i+1];
						b=data[i+2];
						a = data[i+3]
						var pixel = [r,g,b,a]
						var d = meme.applyFilter(filter, pixel);
						data[i] = d[0];
						data[i+1] = d[1];
						data[i+2] = d[2];
						data[i+3] = d[3]
						imgdata.data = data;	
					}
					meme.renderCanvas();
				}
				else {
					meme.redraw();
					imgdata = imgData;
					meme.renderCanvas();
				}	
				
			},
			renderCanvas: function() {	
				ctx.putImageData(imgdata, 0, 0);
				var width = windWidth;
				var r = this.img.width/this.img.height;
				var h = width/r;
				// if (h > windWidth){
				// 	h = windWidth;
				// }
				if(this.topTxt.value !== null){
					ctx.fillText(this.topTxt.value, width/2,40);
					ctx.strokeText(this.topTxt.value, width/2, 40);
				}
				if(this.bottomTxt.value !== null && this.bottomTxt.value !== undefined){
					ctx.fillText(this.bottomTxt.value,width/2,h-20);
					ctx.strokeText(this.bottomTxt.value, width/2, h -20);
				}
			},
			getFieldValues: function(){
				return [this.topTxt.value, this.bottomTxt.value];
			},
			adjustFontHeight: function() {
				meme.redraw();
			},
			applyFilter: function(filter, pixel) {
				switch(filter){
					case 'greyscale':
						var avg =  parseFloat((pixel[0]+pixel[1]+pixel[2])/3);
						pixel = [avg,avg,avg, pixel[3]];
						break;
					case 'red':
						var avg =  parseFloat((pixel[0]+pixel[1]+pixel[2])/3);
						pixel = [avg, 0, 0, pixel[3]];
						break;
					case 'green':
						var avg =  parseFloat((pixel[0]+pixel[1]+pixel[2])/3);
						pixel = [0, avg, 0, pixel[3]];
						break;	
					case 'blue':
						var avg =  parseFloat((pixel[0]+pixel[1]+pixel[2])/3);
						pixel = [0, 0, avg, pixel[3]];
						break;
					case 'onlyRed':
						if(true) {
							var avg =  parseFloat((pixel[0]+pixel[1]+pixel[2])/3);
							pixel = [avg, 0, 0, pixel[3]];
						}
						else {
							var avg =  parseFloat((pixel[0]+pixel[1]+pixel[2])/3);
							pixel = [avg,avg,avg, pixel[3]];
						}
						break;	
					default:
						pixel = [pixel[0]*meme.r, pixel[1]*meme.g, pixel[2]*meme.b, pixel[3]*meme.a];
						break;
				}
				return pixel;
			},
			imgData: function() {
				return imgData;
			},
			activateListners: function() {
				this.saveBtn = document.getElementsByClassName('save')[0];
				this.saveBtn.addEventListener('click', function() {
					meme.saveImg();
				});
				var filterOptions = document.querySelectorAll('input[name="filterType"]');
				for (filterType in filterOptions) {
					filterOptions[filterType].onclick = function (){
						if (this.value === "presets") {
							document.getElementsByClassName('presets')[0].style.display = "block";
							document.getElementsByClassName('diy')[0].style.display = "none";
						}
						else {
							document.getElementsByClassName('diy')[0].style.display = "block";
							document.getElementsByClassName('presets')[0].style.display = "none";
						}
					};
				}
				document.querySelector('#upload').addEventListener('change',this.fileSelect,false);
			},
			saveImg: function(){
				window.open(c.toDataURL(this.img));
			},
			textListner: function() {
				meme.redraw();
			},
			redraw: function() {
				var img = this.src, topTxt = this.topTxt.value, bottomTxt = this.bottomTxt.value;
				ctx.clearRect(0, 0, c.width, c.height);
				if (img !== null && img !== undefined){
					var width = windWidth;
					var r = this.img.width/this.img.height;
					var h = width/r;
					// if (h > windWidth){
					// 	h = windWidth;
					// }
					this.adjustCanvasDimension(h, width);
					ctx.drawImage(img, 0,0, width, h);
					imgData = ctx.getImageData(0,0,c.width, c.height);
					if(topTxt !== null){
						ctx.fillText(topTxt,width/2,40);
						ctx.strokeText(topTxt, width/2, 40);
					}
					if(bottomTxt !== null && bottomTxt !== undefined){
						ctx.fillText(bottomTxt,width/2,h-20);
						ctx.strokeText(bottomTxt, width/2, h -20);
					}
				}
				else{
					alert('Please upload an Image before generating Meme');
				}
				
				
			},
			adjustCanvasDimension: function(h,w){
				c.width = w;
				c.height = h;
				ctx.fillStyle = "#ffffff";
				ctx.strokeStyle = "#000000";
				ctx.font = "bold "+this.fontHeight.value+"pt Roboto";
				ctx.textAlign = "center";
				ctx.lineWidth = "3pt";
			},
			fileSelect: function(evt) {
				var cH = windWidth;
				var cW = windWidth;
				var file = evt.target.files[0];

				var reader = new FileReader();
				reader.onload = function(obj){
					var data = obj.target.result;

					var img = new Image();

					img.onload = function() {
						meme.src = this;
						meme.img = img;
						meme.redraw();
					};
					img.src = obj.target.result;
					if (img.src != "") {
						document.querySelector('.textSetup').style.display = "block";
						document.querySelector('.imageSetup').style.display = "block";
						document.querySelector('.saveImg').style.display = "block";
					}
				};
				reader.readAsDataURL(file);

			}

		};

		meme.init();

		// c.onclick = function(e) {
		// 	var pos = findPos(this);
		//     var x = e.pageX - pos.x;
		//     var y = e.pageY - pos.y;
		//     var coord = "x=" + x + ", y=" + y;
		//     var p = ctx.getImageData(x, y, 1, 1).data; 
		//     var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
		//     document.querySelector('#status').innerHTML= coord + "<br>" + hex;
		// };

		// function findPos(obj) {
		//     var curleft = 0, curtop = 0;
		//     if (obj.offsetParent) {
		//         do {
		//             curleft += obj.offsetLeft;
		//             curtop += obj.offsetTop;
		//         } while (obj = obj.offsetParent);
		//         return { x: curleft, y: curtop };
		//     }
		//     return undefined;
		// }

		// function rgbToHex(r, g, b) {
		//     if (r > 255 || g > 255 || b > 255)
		//         throw "Invalid color component";
		//     return ((r << 16) | (g << 8) | b).toString(16);
		// }

	</script>
	<div id="status"></div>
</body>
</html>
